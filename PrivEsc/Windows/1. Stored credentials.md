A windows environment can contain many stored credentials in files (xml, txt, conf, etc.). These files can be used by a penetration tester to gain elevated privilege. This is the easiest and most straight-forward approcah to windows privillege escalation. 

### Unattend.xml
During an unattended installation, administrators deploy Windows operating system throughout the network automatically (using windows deployment services). Unattended installation creates Unattended.xml files which store local administrator credentials. 

These files can be found in the locations: 

```
C:\unattend.xml
C:\Windows\Panther\Unattend.xml
C:\Windows\Panther\Unattend\Unattend.xml
C:\Windows\system32\sysprep.inf
C:\Windows\system32\sysprep\sysprep.xml
```

Rather than manually searching, **metasploit** contains a module that can automate this process:
`post/windows/gather/enum_unattend`

### web.config
If a windows server is running an IIS server, the web.config file could contain administrator credentials. 

These files can be foud in the following locations: 

```
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config
C:\inetpub\wwwroot\web.config
```

### Group policiy prefrence 
Group policiy prefrence allow domain administrators to configure, deploy and manage the domian more effectively. These files (group.xml) contain user credentials and are accessable by **anyone** in the domain. These files are encrypted but an attacker can be decrypt it easily as microsoft has [published the public key](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN).

The groups.xml file is is located in the *SYSVOL* folder in the **domain controller** and can be accessed by any low privilleged account. There might be multiple groups.xml present in a domain. Some of these might contain the *cpassword* field. The contents of the *cpassword* field are encrpyted using the public key mentioned above. 

The *cpassword* attribute can also be found in the following files: 

```
Services\Services.xml
ScheduledTasks\ScheduledTasks.xml
Printers\Printers.xml
Drives\Drives.xml
DataSources\DataSources.xml

```

#### Tools 
- The metasploit modue, `post/windows/gather/credentials/gpp` can be used to retrive cpassword and decrypt them. (Requires a meterpreter session.)
- The metasploit module, `exploit/windows/smb/psexec` can use the stolen credentials for *lateral movement.* (Requires a meterpreter session.)
- [This ruby script](https://gist.github.com/rmrt1n/f1b01a4017036514cc2aac654f372fc7) by Chris Gates can also be used to decrpyt stolen *cpasswords*.
- gp3finder.py can be found [here](https://bitbucket.org/grimhacker/gpppfinder/src/master/) and compiled windows excutable can be found [here](https://bitbucket.org/grimhacker/gpppfinder/downloads/). (This tool is preferred.)

More info on gp3finder (alone with info on other tools) can be found on this [blog](https://grimhacker.com/2015/04/10/gp3finder-group-policy-preference-password-finder/) by grimhacker.

Read more about GPP for privilege escalation [here](https://www.mindpointgroup.com/blog/privilege-escalation-via-group-policy-preferences-gpp).

### Finding credentials
Instead of manually finding files of interest, the following commands can be used to find files that contain the word 'password':
```
findstr /si password *.txt
findstr /si password *.xml
findstr /si password *.ini
```

Similarly, the following commands can be run to find the files that might contain credentials:
```
C:\> dir /b /s unattend.xml
C:\> dir /b /s web.config
C:\> dir /b /s sysprep.inf
C:\> dir /b /s sysprep.xml
C:\> dir /b /s *pass*
C:\> dir /b /s vnc.ini
```

The following register can be queried to find credentials:
```
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon" (Windows auto logon)
reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP" (SNMP parameters)
```

Some [PowerSploit](https://github.com/PowerShellMafia/PowerSploit) modules can be used to to find creadentials. These modules include 
1. Get-UnattendedInstallFile
2. Get-Webconfig
3. Get-ApplicationHost
4. Get-SiteListPassword
5. Get-CachedGPPPassword
6. Get-RegistryAutoLogon

### Aditional resources

1. Pentest Labs [article](https://pentestlab.blog/2017/04/19/stored-credentials/) on stored credentials. 
2. Pentest Labs [article](https://pentestlab.blog/2017/03/20/group-policy-preferences/) on GPP.
3. MindPoint group [blog](https://www.mindpointgroup.com/blog/privilege-escalation-via-group-policy-preferences-gpp) on GPP.
