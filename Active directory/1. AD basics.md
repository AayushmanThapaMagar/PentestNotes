**Active Driectory (AD)** is a directory service for windows environments. It has a hierarchical structure that enables centealized management of organization's resouces. 

#### Purpose of AD:
1. Authentication
2. Authorization
3. Name resolution
4. Centralized management

AD enumeration makes it easy to find valuable information about the domain even through a single user account. Identifiying Administrative users and misconfiguration. 

95% of Fortune 500 companies used AD. AD is incredibly common and it will be encountered often in a pentesting career. 

## Structure of AD:
1. **Organizational units (OU)** : The smallest unit of AD. It contains users, compluters, groups. 
2. **Domains** : Domains contains OU, computers, users, groups that are under a single administration. Domains can also have child domains.
3. **Trees** : Trees are a collection of domains. Domains in a tree all share the same name space.
4. **Forest** : Like the name suggests, forests are a collection of trees. No two tree in the active directory can share the same name space.

![](https://academy.hackthebox.com/storage/modules/74/ad_forests.png)
![](https://academy.hackthebox.com/storage/modules/74/ilflog2.png)

## Components of AD
1. **Objects**: Rosources present in AD environment. Users, printers, computers, etc.
![](https://academy.hackthebox.com/storage/modules/74/adobjects.png)
2. **Attributes** : Characteristics used to define objects. 
3. **Schema** : Blueprint of the enterprise environment. Defines what kind of objects can exist in the AD and their associated attributes.
4. **Global unique identifier (GUID)** : *Unique* 128-bit identifier assigned when an object is created.
5. **Security Principals** : Objects that can be authenticated by the operating system.
6. **Security Identifiers (SID)** : *Unique* identifier for security principals. Even if the security principal is deleted, the SID cannot be reused.
7. **Names** :
	1. **Distinguished Name (DN)** : Full path to the object in the AD. *(cn, ou, dc)*
	2. **Relative Distinguished Name (RDN)** : Relative name (cn) must be unique in the current level of the domain.
	![](https://academy.hackthebox.com/storage/modules/74/dn_rdn2.png)
	3. **sAMAccountName** : Username used to login
	4. **UserPrincipalName** : *username@SubDomain.DomainName.TopLevelDomain*
	5. **Service Principal Name (SPN)** : Used by kerberos to identify services.

## NTDS.DIT
NTDS.DIT is locted on a domain controller at ` c:\Windows\NTDS\ `, it stores valuable information about the AD such as:
1. Group object information
2. Group membership information
3. Password hashes for all users in the domain.

## Domain controllers
Computers on the domain that handle AD operations such as authentication requests, verfiy users, access controll to resources. The domain controller validates all requests. It also enforces security policies and stores information about objects present in the domain. 

## Protocols used by AD

1. **Kerberos**: Kerberos is a stateless authentication protocol used by AD. It is an open standard and has compatibility with other services. Domain controllers have Kerberos Key Distribution Center (KDC) that issues tikects. When user attempts to login, they are encrypting the ticket with their password and if DC can decrypt it, they are granted access. 
   ![](https://academy.hackthebox.com/storage/modules/74/Kerb_auth.png)

2. **DNS (Domain name service)**: Convery domain names into IP addresses which can be used by computers for required purpose. We can use ``nslookup <IP addr or Domain name> ``
    ![](https://academy.hackthebox.com/storage/modules/74/dns_highlevel.png)
	
3. **Lightweight Directory Access Protocol (LDAP)**: LDAP is an open-source, cross-platform and vendor neutral application layer protocol that enables locating, accessing and maintaining data in AD. LDAP can also tackle user authentication which enables users to access many resources and services by signing in once. It uses SASL Authentication which uses kerberos to authenticate users. 

	![](https://academy.hackthebox.com/storage/modules/74/LDAP_auth.png)

4. **Microsoft Remote Procudure call (MSRP)** : Microsoft implementation of RPC. It is used for client-server model-based application communication. Windows systems use MSRPC to access systems in AD. 

## Hashes in AD
1. **NT**: Can be easily cracked. For example: *`299bd128c1101fd6`*
2. **NTLM**: Can be cracked or used for pass the hash (PTH) attacks. For example:
*`Rachel:500:aad3c435b514a4eeaad3b935b51304fe:e46b9e548fa0d122de7f59fb6d48eaa2:::`*
3. **NTLMv1**: Can be cracked but *cannot* be used for PTH attacks. For example: *`netntlm::kNS:338d08f8e26de93300000000000000000000000000000000:9526fb8c23a90751cdd619b6cea564742e1e4bf33006ba41:cb8086049ec4736c`*
4. **NTLMv2**: Current standard used. For example: *`admin::N46iSNekpT:08ca45b7d7ea58ee:88dcbe4446168966a153a0064958dac6:5c7830315c7830310000000000000b45c67103d07d7b95acd12ffa11230e0000000052920b85f78d013c31cdb3b92f5d765c783030`*
5. **MSCache2**: Hashesh of last 10 users logged in on the system is stored locally. These are extremely slow to crack and cannot be used for PTH attacks. For example: *`$DCC2$10240#bjones#e4e938d12fe5974dc42a90120bd9c90f`*

## Built-in AD groups
`whoami /groups`
`Get_ADGroup -Identity "<Group name>" -Properties *`

1. **Account operators** : Members can create and modify most types of accounts except administrative accounts.
2. **Administrators** : Full unristricted access to a computer (Domain controller included).
3. **Backup operators** : Can log into a computer and shut it down. Can create backup of local files regardless of permission on that file. NTDS.DIT can be cloned.
4. **DnsAdmins** :  Members have access to network DNS information.
5. **Domain Admins** : Full administrative access to the domain and computers in domain.
6. **Domain Computers** : Computers present in a domain (except domain controllers).
7. **Domain Controllers** : All domain controllers are present in this group. New DCs added automatically.
8. **Domain Users** : All users present in the domain. New users are added automatically.
9. **Enterprise Admins** : Complete configuration access within domain. Only present in the root domain. Can make forest-wide changes such as creatating chuld domain or adding forest trust.
10. **Event Log Readers** : Can read event logs on local computers.
11. **Group Policy Creator Owners** : Can create, edit, or delete group policiy objects in a domain.
12. **Hyper-V Administrators** : Complete unrestricted access to features of hyper-v. Should be considered domain admins if there are virtual DC present.
13. **IIS_USRS** : Used by Internet Information services (IIS).
14. **Pre-windows 2000 compatible access** : This group exists to provide backwards compatibility for computers running Windows NT 4.0 and earlier.
15. **Print Operators** : Members can manage, create, delete prtinters present in the domain. 
16. **Protected Users** : Members in this group are provided aditional security against kerberos attacks.
17. **Read-only Domain controllers** : Contains all read-only domain controllers present in the domain.
18. **Remote Desktop users** : Members are allowed to connect remotely via RDP.
19. **Remote Management users** : Member are granted access to computers via WinRM.
20. **Schema Admins** : Members can modify AD schema. Group only exists in root domain in a forest. 
21. **Server operators** : Members can modify services, access SMB shares, and backup files on the domain controllers. Group exists on domain controllers and by default has no members.

## User Rights 

`whoami /priv`

1. **SeRemoteInteractiveLogonRight** : User can log onto a host via RDP.
2. **SeBackupPrivilege** : User can create backups of files (SAM, System Registry, NTDS.dit)
3. **SeDebugPrivilege** : Users with this privilege can read contents of memory and can be used to steal credentials (Mimikatz). 
4. **SeImpersonatePrivillege** : Allows users to impersonate a tokan of a privileged account such as *NTAUTHORITY\SYSTEM* for privilege escalation. (JuicyPotato, RougeWinRM, PrintSpoofer). 
5. **SeLocalDriverPrivilege** : Users can load and unload drivers in a system.
6. **SeTakeOwnershipPrivilege** : Allows users to take ownership of an AD object. 

Methods to abuse privilege [here](https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/privilege-escalation-abusing-tokens) and [here](https://blog.palantir.com/windows-privilege-abuse-auditing-detection-and-defense-3078a403d74e)

